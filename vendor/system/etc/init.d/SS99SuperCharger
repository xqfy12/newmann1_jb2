#!/system/bin/sh
#
# V6 SuperCharger, OOM Grouping & Priority Fixes created by zeppelinrox.
#
# SuperMinFree Calculator & MFK Calculator (for min_free_kbytes) created by zeppelinrox also ;^]
#
# See http://goo.gl/krtf9 - Linux Memory Consumption - Nice article!
# See http://goo.gl/hFdNO - Memory and SuperCharging Overview ...or... "Why 'Free RAM' Is NOT Wasted RAM!"
# See http://goo.gl/4w0ba - MFK Calculator Info - explanation for vm.min_free_kbytes.
#
  ################################
 #  SuperCharger Service Notes  #
################################
# To leave the SuperCharger Service running, insert a # at the beginning of the "stop super_service" entry near the bottom of this script (3rd or 4th last line).
#
# To stop the SuperCharger Service, run Terminal Emulator and type...
# "su" and Enter.
# "stop super_service" and Enter.
#
# To restart the SuperCharger Service so it stays running, type...
# "su" and Enter.
# "start super_service" and Enter.
#
# If the service is running and you type: "cat /proc/*/cmdline | grep Super".
# The output would be 2 lines:
# /data/99SuperCharger.sh
# Super
#
# If it's not running, the output would be the last item ie. "Super" which was generated by the typed command.
#
if [ "`pgrep -l android`" ]; then terminate=yes;
else
	if [ -f "/data/!!SuperChargerBootLoopMessage.log" ]; then
		echo " $( date +"%m-%d-%Y %H:%M:%S" ): $0 Detected A BootLooped... ABORTING..." >> /data/Ran_SuperCharger.log;
		exit 69;
	fi;
	echo " Delete this file to Re-Enable *99SuperCharger to run on boot..." > /data/!!SuperChargerBootLoopMessage.log;
fi;
#
# Ummm... this service won't work on your current ROM. Sorry :P
# Instead use Script Manager to run this script if you're on a stock ROM OR settings don't stick via the SuperCharger boot script found in /system/etc/init.d!
#
# For debugging, delete the # at the beginning of the following 2 lines, and check /data/Log_SuperCharger.log file to see what may have fubarred.
set -x;
exec > /data/Log_SuperCharger.log 2>&1;
echo ""; echo " See /data/Log_SuperCharger.log for the output!"; echo "";
#
line=================================================;
echo "";
echo $line;
echo "   The -=V6 SuperCharger=- by -=zeppelinrox=-";
echo $line;
echo "";
id=`id`; id=`echo ${id#*=}`; id=`echo ${id%%\(*}`; id=`echo ${id%% *}`;
if [ "$id" != "0" ] && [ "$id" != "root" ]; then
	echo " You are NOT running this script as root...";
	echo "";
	echo $line;
	echo "                      ...No SuperUser for you!!";
	echo $line;
	echo "";
	echo "     ...Please Run as Root and try again...";
	echo "";
	echo $line;
	echo "";
	exit 69;
fi;
echo " To verify application of settings...";
echo "";
echo "       ...check out /data/Ran_SuperCharger.log!";
echo "";
echo $line;
echo "";
busybox mount -o remount,rw /data 2>/dev/null;
busybox mount -o remount,rw /system 2>/dev/null;
busybox mount -o remount,rw `busybox mount | grep system | awk '{print $1,$3}' | sed -n 1p` 2>/dev/null;
mv $0 /system/etc/init.d/99SuperCharger;
for i in `busybox ls -r /system/etc/init.d`; do
	if [ "$j" ]; then break; fi;
	if [ ! -d "$i" ]; then j=$i; fi;
done;
echo " SuperCharger to run on boot as...";
echo "";
echo $line;
if [ "$j" = "S98KickAssKernel" ] || [ "$j" = "SS98KickAssKernel" ] && [ "$i" \< "99SuperCharger1" ] || [ "$j" \< "99SuperCharger1" ]; then
	echo "          .../system/etc/init.d/99SuperCharger!";
elif [ "$j" = "SS98KickAssKernel" ] && [ "$i" \< "S99SuperCharger" ] || [ "$j" \< "S99SuperCharger" ]; then
	mv /system/etc/init.d/99SuperCharger /system/etc/init.d/S99SuperCharger;
	echo "         .../system/etc/init.d/S99SuperCharger!";
else
	mv /system/etc/init.d/99SuperCharger /system/etc/init.d/SS99SuperCharger;
	echo "        .../system/etc/init.d/SS99SuperCharger!";
fi;
echo $line;
echo "";
if [ "$terminate" ]; then
	sed -i 's/# exec >/exec >/' /data/V6_SuperCharger/!WheelAlignment.sh 2>/dev/null;
	sh /data/V6_SuperCharger/!WheelAlignment.sh & 2>/dev/null; sleep 1;
	sed -i 's/exec >/# exec >/' /data/V6_SuperCharger/!WheelAlignment.sh 2>/dev/null;
	if [ ! "`pgrep scriptmanager`" ]; then
		echo " Waiting 90 seconds (avoid conflicts)... then...";echo "";
		echo " Gonna SuperCharge this Android... zoOM... zOOM!";
		echo "";
		echo $line;
		echo "";
		sleep 90;
	fi;
fi;
if [ "`cat /proc/sys/vm/min_free_kbytes`" -ne 34406 ] || [ "`cat /proc/sys/net/core/rmem_max`" -ne 1048576 ] || [ "`cat /sys/block/mmcblk0/bdi/read_ahead_kb`" -ne 2056 ]; then
	  ####################################
	 #  Kernel & Virtual Memory Tweaks  #
	####################################
	busybox sysctl -w vm.min_free_kbytes=34406;
	busybox sysctl -w vm.oom_kill_allocating_task=0;
	busybox sysctl -w vm.panic_on_oom=0;
	busybox sysctl -w vm.overcommit_memory=1;
	busybox sysctl -w vm.swappiness=20;
	busybox sysctl -w kernel.panic_on_oops=1;
	busybox sysctl -w kernel.panic=30;
	  ##################################
	 #  3G TurboCharger Enhancement!  #
	#################=################
	busybox sysctl -w net.core.wmem_max=1048576;
	busybox sysctl -w net.core.rmem_max=1048576;
	busybox sysctl -w net.core.optmem_max=20480;
	busybox sysctl -w net.ipv4.tcp_moderate_rcvbuf=1;        # Be sure that autotuning is in effect
	busybox sysctl -w net.ipv4.route.flush=1;
	busybox sysctl -w net.ipv4.udp_rmem_min=6144;
	busybox sysctl -w net.ipv4.udp_wmem_min=6144;
	busybox sysctl -w net.ipv4.tcp_rmem='6144 87380 1048576';
	busybox sysctl -w net.ipv4.tcp_wmem='6144 87380 1048576';
	  #########################
	 #  SD Read Speed Tweak  #
	#########################
	if [ "`ls /sys/devices/virtual/bdi/179*/read_ahead_kb`" ]; then
		for i in `ls /sys/devices/virtual/bdi/179*/read_ahead_kb`; do echo 2056 > $i; done;
	fi 2>/dev/null;
	echo 2056 > /sys/block/mmcblk0/bdi/read_ahead_kb 2>/dev/null;
	echo 2056 > /sys/block/mmcblk0/queue/read_ahead_kb 2>/dev/null;
	echo "";
	echo $line;
	echo "";
fi;
currentadj=`cat /sys/module/lowmemorykiller/parameters/adj`;
currentminfree=`cat /sys/module/lowmemorykiller/parameters/minfree`;
scadj=`cat /data/V6_SuperCharger/SuperChargerAdj`;
scminfree=`cat /data/V6_SuperCharger/SuperChargerMinfree`;
if [ "$scminfree" ] && [ "$currentminfree" != "$scminfree" ]; then applyscminfree=yes; fi;
if [ "$scadj" ] && [ "$currentadj" != "$scadj" ]; then applyscadj=yes; fi;
if [ "$applyscminfree" ] || [ "$applyscadj" ]; then
	chmod 777 /sys/module/lowmemorykiller/parameters/adj;
	chmod 777 /sys/module/lowmemorykiller/parameters/minfree;
	if [ "$scadj" ]; then echo $scadj > /sys/module/lowmemorykiller/parameters/adj; fi;
	if [ "$scminfree" ]; then echo $scminfree > /sys/module/lowmemorykiller/parameters/minfree; fi;
	echo " $( date +"%m-%d-%Y %H:%M:%S" ): Applied settings from $0!" >> /data/Ran_SuperCharger.log;
	echo "         SuperCharger Settings Applied!";
elif [ "`pgrep -l android`" ]; then
	echo " $( date +"%m-%d-%Y %H:%M:%S" ): No need to reapply settings from $0!" >> /data/Ran_SuperCharger.log;
	echo " SuperCharger Settings Were ALREADY Applied...";
	echo "";
	echo "            ...there's no need to reapply them!";
fi;
echo "";
echo " $0 Executed...";
echo "";
echo "          ===========================";
echo "           ) SuperCharge Complete! (";
echo "          ===========================";
if [ "$terminate" ]; then
	busybox mount -o remount,ro /system 2>/dev/null;
	busybox mount -o remount,ro `busybox mount | grep system | awk '{print $1,$3}' | sed -n 1p` 2>/dev/null;
#	stop super_service;
else
	rm /data/!!SuperChargerBootLoopMessage.log;
	$0 & exit 0;
fi;
sh /system/etc/init.d/*KickAssKernel & 2>/dev/null;
sh /data/99SuperCharger.sh & 2>/dev/null;
sed -i 's/# exec >/exec >/' /data/V6_SuperCharger/!FixEmissions.sh 2>/dev/null;
sh /data/V6_SuperCharger/!FixEmissions.sh & 2>/dev/null; sleep 1;
sed -i 's/exec >/# exec >/' /data/V6_SuperCharger/!FixEmissions.sh 2>/dev/null;
sleep 60;
sed -i 's/# exec >/exec >/' /data/V6_SuperCharger/!Detailing.sh 2>/dev/null;
sh /data/V6_SuperCharger/!Detailing.sh & 2>/dev/null; sleep 1;
sed -i 's/exec >/# exec >/' /data/V6_SuperCharger/!Detailing.sh 2>/dev/null; sleep 480;
sed -i 's/# exec >/exec >/' /data/V6_SuperCharger/!FastEngineFlush.sh 2>/dev/null;
sh /data/V6_SuperCharger/!FastEngineFlush.sh & 2>/dev/null; sleep 1;
sed -i 's/exec >/# exec >/' /data/V6_SuperCharger/!FastEngineFlush.sh 2>/dev/null;
# End of V6 SuperCharged Entries.
